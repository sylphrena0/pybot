{% extends 'base.html' %}

{% block header %}
  <h1>{% block title %}Control{% endblock %}</h1>
  {% if g.user %}
  <a class="action" href="{{ url_for('control.settings') }}">Settings</a>
  {% endif %}
{% endblock %}

{% block content %}

<img src="{{ url_for('control.video_feed') }}" class="center">

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

<div class = centerdiv>

<input type="submit" class="button" value="Forward" id="forward" onmousedown="forward()" onmouseup="stop()" style="margin-top: 16"/><br>
<input type="submit" class="button" value="Left" id="left" onmousedown="left()" onmouseup="stop()"/>
<input type="submit" class="button" value="Right" id="right" onmousedown="right()" onmouseup="stop()"/><br>
<input type="submit" class="button" value="Back" id="back" onmousedown="back()" onmouseup="stop()"/>

<script type=text/javascript>

var isActive = {}; //dict for active keys

$(document).keydown(function(e){ //when a key is pressed
isActive[e.keyCode] = e.type == 'keydown'; //update active key dictionary
if (e.keyCode==38) { //if the key is up
    $.getJSON('/move?command=forward', function(data) {});  //moves forward
} else if (e.keyCode==40) { //key is down
   $.getJSON('/move?command=backward', function(data) {}); //moves backward
} else if (e.keyCode==37 && isActive[38]) { //if current key event is left arrow and up arrow is active
    $.getJSON('/move?command=leftTurn', function(data) {}); //turns left
} else if (e.keyCode==37 && isActive[40]) { //if current key event is left arrow and down arrow is active
    $.getJSON('/move?command=leftTurn&direction=backward', function(data) {}); //turns left while going backward
} else if (e.keyCode==39 && isActive[38]) { //if current key event is right arrow and up/down is currently active
    $.getJSON('/move?command=rightTurn', function(data) {}); //turns right
} else if (e.keyCode==39 && isActive[40]) { //if current key event is right arrow and up/down is currently active
    $.getJSON('/move?command=rightTurn&direction=backward', function(data) {}); //turns right while going backward
  };
});

$(document).keyup(function(e){ //when a key is released
isActive[e.keyCode] = e.type == 'keydown';  //update active key dictionary
if (e.keyCode==38 || e.keyCode==40){ //if the released key is up/down arrow
    $.getJSON('/move?command=stop', function(data) {}); //stops the car
} else if ((e.keyCode==39 || e.keyCode==37) && isActive[38]) { //if current key event is left/right arrow and up is currently active
   $.getJSON('/move?command=forward', function(data) {});  //continues forward, ending the turn
} else if ((e.keyCode==39 || e.keyCode==37) && isActive[40]) { //if current key event is right arrow and up/down is currently active
    $.getJSON('/move?command=backward', function(data) {}); //continues forward, ending the turn
  };
});

</script>

</div>
{% endblock %}