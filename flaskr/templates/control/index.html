{% extends 'base.html' %}

{% block header %}
  <h1>{% block title %}Control{% endblock %}</h1>
  {% if g.user %}
  <a class="action" href="{{ url_for('control.settings') }}">Settings</a>
  {% endif %}
{% endblock %}

{% block content %}

<img src="{{ url_for('control.video_feed') }}" class="center"  style="margin-top:25px;">

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

<div class = centerdiv>

<input type="submit" class="button" value="Forward" id="forward" onmousedown="forward()" onmouseup="stop()" style="margin-top:25px;"/><br>
<input type="submit" class="button" value="Left" id="left" onmousedown="left()" onmouseup="stop()" style="margin-right: 25px;"/>
<input type="submit" class="button" value="Right" id="right" onmousedown="right()" onmouseup="stop()" style="margin-left: 25px;"/><br>
<input type="submit" class="button" value="Backward" id="back" onmousedown="back()" onmouseup="stop()"/>

<script type=text/javascript>

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

var isActive = {}; //dict for active keys
var up = false;
var down = false;
var left = false;
var right = false;

$(document).keydown(function(e){ //when a key is pressed
isActive[e.keyCode] = e.type == 'keydown'; //update active key dictionary - https://keycode.info/

//define forward and back conditions
if (e.keyCode==38 && !isActive[37] && !isActive[39] && !isActive[40] && !up) { //if the key is up and no other arrows are being pressed, and this is the first call
    $.getJSON('/move?command=forward', function(data) {});  //moves forward
    up = true; //sets the first call flag
    console.log("moving forward");
} else if (e.keyCode==40 && !isActive[37] && !isActive[39] && !isActive[38] && !down) { //key is down and no other arrows are being pressed, and this is the first call
    $.getJSON('/move?command=backward', function(data) {}); //moves backward 
    down = true;
    console.log("moving backwards");
/* define left and right conditions - these do not work with current motors and wheels
} else if (e.keyCode==37 && !isActive[39] && !isActive[38] && !isActive[40] && !left) { //key is left and no other arrows are being pressed, and this is the first call
    $.getJSON('/move?command=leftTurn&direction=stationary', function(data) {}); //turns left
    console.log("turning left")
    left = true
} else if (e.keyCode==39 && !isActive[37] && !isActive[38] && !isActive[40] && !right) { //key is right and no other arrows are being pressed, and this is the first call
    $.getJSON('/move?command=rightTurn', function(data) {}); //turns right
    console.log("turning right")
    right = true */
//define combinations of left/right and forward/back conditions
} else if ([37,40,38].includes(e.keyCode) && (isActive[37] && isActive[40]) || (isActive[37] && isActive[38]) && !isActive[39] && !left) { //if current key event is left arrow, up arrow is active, and no other keys are being pressed
    if (isActive[38]) {
      $.getJSON('/move?command=leftTurn&direction=forward', function(data) {}); //turns left
      up = true;
      console.log("turning left (forward)")
    } else if (isActive[40]){
      $.getJSON('/move?command=leftTurn&direction=backward', function(data) {}); //turns left while going backward
      down = true;
      console.log("turning left (backward)")
    };
  left = true;
  console.log("left marked")

} else if ([38,39,40].includes(e.keyCode) && (isActive[39] && isActive[40]) || (isActive[39] && isActive[38]) && !isActive[37] && !right) { //if current key event is right arrow and up is currently active
    if (isActive[38]) {
        $.getJSON('/move?command=rightTurn&direction=forward', function(data) {}); //turns right
        up = true;
        console.log("turning right (forward)")
    } else if (isActive[40]){
        $.getJSON('/move?command=rightTurn&direction=backward', function(data) {}); //turns right while going backward
        down = true;
        console.log("turning right (backward)")
      };
    right = true;
  };
});

$(document).keyup(function(e){ //when a key is released
isActive[e.keyCode] = e.type == 'keydown';  //update active key dictionary
if (e.keyCode==38 || e.keyCode==40){ //if the released key is up/down arrow
    $.getJSON('/move?command=stop', function(data) {}); //stops the car
    sleep(100); //debounce of 100ms
    up = false //resets first call flag
    down = false //resets first call flag
};
 else if ((e.keyCode==39 || e.keyCode==37) && isActive[38]) { //if current key event is left/right arrow and up is currently active
   left = false
   right = false
} else if ((e.keyCode==39 || e.keyCode==37) && isActive[40]) { //if current key event is left/right arrow and down is currently active
    left = false
    right = false
  };
});

</script>

</div>
{% endblock %}